name: Auto-Post Article to Facebook

on:
  push:
    branches:
      - main # CHANGE THIS to match your default branch (e.g., 'master')
    paths:
      - '_posts/**' # Trigger ONLY when files in _posts change (added or modified)

jobs:
  facebook_post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2 # Fetch enough history to compare with previous commit

      - name: Install yq (YAML processor)
        run: sudo apt-get update && sudo apt-get install -y yq

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # Step 1: Find ONLY the post files that were actually modified in this push
      - name: Find Modified Post Files in This Push
        id: find_files
        run: |
          # Use the push range to find changed files
          BEFORE=${{ github.event.before }}
          AFTER=${{ github.event.after }}
          
          # For initial push, compare with HEAD~1
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            echo "Initial push detected, comparing with HEAD~1"
            CHANGED_FILES=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD -- _posts/*.md 2>/dev/null || git ls-files _posts/*.md)
          else
            echo "Push range: $BEFORE -> $AFTER"
            CHANGED_FILES=$(git diff --name-only --diff-filter=AM $BEFORE $AFTER -- _posts/*.md)
          fi
          
          echo "Changed files in this push:"
          echo "$CHANGED_FILES"
          
          # Check if any files were found
          if [ -z "$CHANGED_FILES" ]; then
            echo "No post files were modified in this push. Exiting."
            exit 0
          fi
          
          # Take only the first file if multiple were changed
          LATEST_POST=$(echo "$CHANGED_FILES" | head -n 1)
          
          echo "Processing post: $LATEST_POST"
          echo "file_path=$LATEST_POST" >> $GITHUB_OUTPUT

      # Step 2: Check if the modified post is a DRAFT
      - name: Check if Post is Draft
        id: check_draft
        run: |
          POST_PATH=${{ steps.find_files.outputs.file_path }}
          
          # Verify file exists
          if [ ! -f "$POST_PATH" ]; then
            echo "ERROR: Post file not found at: $POST_PATH"
            exit 1
          fi
          
          echo "Checking draft status for: $POST_PATH"
          
          # Extract categories from YAML front matter
          FRONT_MATTER=$(awk '/^---$/{p=!p; next} p' "$POST_PATH")
          CATEGORIES=$(echo "$FRONT_MATTER" | yq '.categories')
          
          echo "Categories: $CATEGORIES"
          
          # Check if this post is a DRAFT
          if [[ "$CATEGORIES" == *"DRAFT"* ]]; then
            echo "Post is marked as DRAFT, skipping all processing"
            echo "is_draft=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Post is not a draft, continuing"
          echo "is_draft=false" >> $GITHUB_OUTPUT

      # Step 3: Extract Metadata and Build URL
      - name: Extract Post Metadata and Build URL
        if: steps.check_draft.outputs.is_draft != 'true'
        id: metadata
        run: |
          POST_PATH=${{ steps.find_files.outputs.file_path }}
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          if [ ! -f "$POST_PATH" ]; then
            echo "ERROR: Post file not found at: $POST_PATH"
            exit 1
          fi
          
          echo "Processing post file: $POST_PATH"
          
          # Extract YAML front matter
          FRONT_MATTER=$(awk '/^---$/{p=!p; next} p' "$POST_PATH")
          TITLE=$(echo "$FRONT_MATTER" | yq '.title')
          COVER_PATH=$(echo "$FRONT_MATTER" | yq '.cover')
          EXISTING_MODIFIED=$(echo "$FRONT_MATTER" | yq '.modified_date')
          CATEGORIES=$(echo "$FRONT_MATTER" | yq '.categories')
          
          echo "Extracted metadata - Title: $TITLE, Categories: $CATEGORIES, Existing Modified: $EXISTING_MODIFIED"
          
          # Extract the first category - handle both string and array formats
          if echo "$CATEGORIES" | grep -q '^\['; then
            # It's an array - extract first element
            CATEGORY=$(echo "$CATEGORIES" | yq '.[0]' 2>/dev/null || echo "$CATEGORIES" | sed 's/\[//;s/\]//;s/,.*//;s/"//g;s/ //g')
          else
            # It's a string - use as-is, remove quotes
            CATEGORY=$(echo "$CATEGORIES" | sed 's/"//g')
          fi
          
          echo "Primary category for URL: $CATEGORY"
          
          # Build URL with category: {base_url}/{category}/{year}/{month}/{day}/{slug}.html
          FILENAME=$(basename "$POST_PATH" .md)
          DATE_PART=$(echo "$FILENAME" | cut -d- -f1-3)
          TITLE_SLUG=$(echo "$FILENAME" | cut -d- -f4-)
          DATE_PATH=$(echo "$DATE_PART" | tr '-' '/')
          POST_URL="${{ secrets.JEKYLL_BASE_URL }}/$CATEGORY/$DATE_PATH/$TITLE_SLUG.html"

          echo "Final POST_URL: $POST_URL"

          # Update modified_date if it doesn't exist or is null
          if [ -z "$EXISTING_MODIFIED" ] || [ "$EXISTING_MODIFIED" = "null" ]; then
            echo "Adding modified_date: $CURRENT_DATE"
            yq eval ".modified_date = \"$CURRENT_DATE\"" "$POST_PATH" > "${POST_PATH}.tmp" && mv "${POST_PATH}.tmp" "$POST_PATH"
            
            if [ $? -eq 0 ]; then
              git add "$POST_PATH"
              git commit -m "[skip ci] Auto-add modified_date to $FILENAME" || true
              MODIFIED_DATE="$CURRENT_DATE"
              echo "Successfully added modified_date"
            else
              echo "Warning: Failed to update modified_date"
              MODIFIED_DATE="$CURRENT_DATE"
            fi
          else
            echo "Post already has modified_date: $EXISTING_MODIFIED"
            MODIFIED_DATE="$EXISTING_MODIFIED"
          fi

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "url=$POST_URL" >> $GITHUB_OUTPUT
          echo "modified_date=$MODIFIED_DATE" >> $GITHUB_OUTPUT

      # Step 5: Wait for site deployment (GitHub Pages takes time to build)
      - name: Wait for Site Deployment
        if: steps.check_draft.outputs.is_draft != 'true'
        run: |
          echo "Waiting 60 seconds for site to deploy..."
          sleep 60

      # Step 6: Publish to Facebook
      - name: Send Post to Facebook
        if: steps.check_draft.outputs.is_draft != 'true' && steps.metadata.outputs.title != ''
        env:
          FB_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
          PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          POST_TITLE: ${{ steps.metadata.outputs.title }}
          POST_URL: ${{ steps.metadata.outputs.url }}
        run: |
          MESSAGE="$POST_TITLE%0A%0ARead full story here: $POST_URL"
          
          echo "Posting to Facebook: $POST_URL"
          echo "Facebook will scrape og:image from: $POST_URL"
          
          curl -X POST "https://graph.facebook.com/$PAGE_ID/feed" \
            -d "message=$MESSAGE" \
            -d "link=$POST_URL" \
            -d "access_token=$FB_TOKEN"
          
          echo "Post attempt completed."