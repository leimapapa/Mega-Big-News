name: Auto-Post Article to Facebook

on:
  push:
    branches:
      - main # CHANGE THIS to match your default branch (e.g., 'master')
    paths:
      - '_posts/**' # Trigger ONLY when files in _posts change (added or modified)

jobs:
  facebook_post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install yq (YAML processor)
        run: sudo apt-get update && sudo apt-get install -y yq

      # Step 1a: Set up git config for commits
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # Step 1: Find the most recently modified post file
      - name: Find Latest Modified Post File Path
        id: find_file
        run: |
          # Find the markdown file in _posts that was modified most recently (ls -t)
          # This ensures we get the most relevant file when Pages CMS pushes changes.
          LATEST_POST=$(ls -t _posts/*.md | head -n 1)
          
          # Check if a post was actually found (avoids errors if _posts is empty or only non-md files changed)
          if [ -z "$LATEST_POST" ]; then
             echo "No post file found or modified. Exiting."
             exit 0
          fi
          
          echo "Found modified post: $LATEST_POST"
          echo "file_path=$LATEST_POST" >> $GITHUB_OUTPUT

      # Step 2: Extract Metadata, Cover Image, and Build URL
      - name: Extract Post Metadata and Build URL
        id: metadata
        # Runs unconditionally since we checked for file existence in Step 1
        run: |
          POST_PATH=${{ steps.find_file.outputs.file_path }}
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          # Use yq to extract the title and cover variables from the YAML front matter
          FRONT_MATTER=$(awk '/^---$/{p=!p; next} p' $POST_PATH)
          TITLE=$(echo "$FRONT_MATTER" | yq '.title')
          COVER_PATH=$(echo "$FRONT_MATTER" | yq '.cover')
          EXISTING_MODIFIED=$(echo "$FRONT_MATTER" | yq '.modified_date')
          
          FILENAME=$(basename $POST_PATH .md)
          DATE_PART=$(echo $FILENAME | cut -d- -f1-3)
          TITLE_SLUG=$(echo $FILENAME | cut -d- -f4-)
          POST_URL="${{ secrets.JEKYLL_BASE_URL }}/$(echo $DATE_PART | tr -s '-' '/')/$TITLE_SLUG.html"

          # Build the full cover image URL if cover path exists
          if [ -n "$COVER_PATH" ] && [ "$COVER_PATH" != "null" ]; then
            COVER_URL="${{ secrets.JEKYLL_BASE_URL }}${COVER_PATH}"
          else
            COVER_URL=""
          fi

          # Update modified_date if it doesn't exist or is null
          if [ -z "$EXISTING_MODIFIED" ] || [ "$EXISTING_MODIFIED" = "null" ]; then
            echo "Adding modified_date: $CURRENT_DATE"
            
            # Use yq to add the modified_date field to the front matter
            yq -i ".modified_date = \"$CURRENT_DATE\"" $POST_PATH
            
            # Commit the change with [skip ci] to prevent workflow re-trigger
            git add $POST_PATH
            git commit -m "[skip ci] Auto-add modified_date to $FILENAME"
            
            MODIFIED_DATE="$CURRENT_DATE"
          else
            echo "Post already has modified_date: $EXISTING_MODIFIED"
            MODIFIED_DATE="$EXISTING_MODIFIED"
          fi

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "url=$POST_URL" >> $GITHUB_OUTPUT
          echo "cover_url=$COVER_URL" >> $GITHUB_OUTPUT
          echo "has_cover=true" >> $GITHUB_OUTPUT
          echo "modified_date=$MODIFIED_DATE" >> $GITHUB_OUTPUT
          
          # Log extracted metadata for debugging
          echo "---"
          echo "Extracted metadata:"
          echo "Title: $TITLE"
          echo "Post URL: $POST_URL"
          echo "Cover URL: $COVER_URL"
          echo "Modified Date: $MODIFIED_DATE"
          echo "---"

      # Step 3: Publish to Facebook via the Graph API
      - name: Send Post to Facebook
        # Check if the title was successfully extracted
        if: steps.metadata.outputs.title != ''
        env:
          FB_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
          PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          POST_TITLE: ${{ steps.metadata.outputs.title }}
          POST_URL: ${{ steps.metadata.outputs.url }}
          COVER_URL: ${{ steps.metadata.outputs.cover_url }}
        run: |
          # The message contains the satire alert and a link.
          MESSAGE="$POST_TITLE%0A%0ARead the updated story here: $POST_URL"
          
          echo "Attempting to post (or re-post) to Facebook for: $POST_URL"
          
          # Build the curl command with cover image if available
          if [ -n "$COVER_URL" ]; then
            echo "Including cover image: $COVER_URL"
            curl -X POST "https://graph.facebook.com/$PAGE_ID/feed" \
              -d "message=$MESSAGE" \
              -d "link=$POST_URL" \
              -d "picture=$COVER_URL" \
              -d "access_token=$FB_TOKEN"
          else
            echo "No cover image found, posting without picture parameter"
            curl -X POST "https://graph.facebook.com/$PAGE_ID/feed" \
              -d "message=$MESSAGE" \
              -d "link=$POST_URL" \
              -d "access_token=$FB_TOKEN"
          fi
          
          echo "Post attempt completed."
